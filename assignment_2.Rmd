---
title: "Assignment_2"
author: "Chuyuan LI"
date: "10/11/2018"
output: html_document
---

```{r setup}
library(ggplot2)
library(dplyr)
source("functions.R")
```

```{r}
`%>%` <- magrittr::`%>%`
```

## Exercise 1
First do some permutation tests for the two subgroups:
```{r cache=TRUE}
# extract subsets from iris
iris_subset_1 <- iris[c(89:94, 108:113),]
iris_subset_2 <- iris[c(88:100,108:120),]

# do permutation tests
ptest_subset1 <- permutation_twogroups(iris_subset_1, "Sepal.Width", "Species", "versicolor",
"virginica", difference_in_medians)

ptest_subset2 <- permutation_twogroups(iris_subset_2, "Sepal.Width", "Species", "versicolor",
"virginica", difference_in_medians)
```

Now plot the histograms
```{r}
# extract the values observed and permuted statistics
observed_value_subset1 <- ptest_subset1["observed"]
ptest_stats_subset1 <- tibble::as_tibble(ptest_subset1["permuted"])
observed_value_subset2 <- ptest_subset2["observed"]
ptest_stats_subset2 <- tibble::as_tibble(ptest_subset2["permuted"])

# plot with the same x scale
lower_lim <- min(ptest_stats_subset1, ptest_stats_subset2)
upper_lim <- max(ptest_stats_subset1, ptest_stats_subset2)
ggplot(ptest_stats_subset1, aes(x=permuted)) + geom_histogram(color="white", fill="blue") + labs(title = "Histogram of observed value and permuted values subset1", x = "permuted values", y = "count") + geom_vline(aes(xintercept=unlist(observed_value_subset1), color = "observed_value"), show.legend = T, size = 1) + xlim(lower_lim, upper_lim)

ggplot(ptest_stats_subset2, aes(x=permuted)) + geom_histogram(color="white", fill="blue") + labs(title = "Histogram of observed value and permuted values subset2", x = "permuted values", y = "count") + geom_vline(aes(xintercept=unlist(observed_value_subset2), color = "observed_value"), show.legend = T, size = 1) + xlim(lower_lim, upper_lim)

```


**Observation from the 2 histograms**:
```
- Statistics for subset1 scattered towards lower and higher tails, while those for subset2 gather up to the center, mostly in the range (-0.25, 0.25). 
- The points for subset 1 are not equally distributed in the bins, with the blank intervals in between, for exemple (-0.25,-0.15), (0.15, 0.25); while for subset 2 they are more equally distributed
- Subset1 takes only 6 data points for each group, while subset2 takes 13 each. The short of data could result in a less representative group of statistics ???

- Observed test statistics for subset 1 is -0.35, for subset 2 is -0.2
- The observed value is a one-chance value, meaning it might not be the most representative among all the possible permutation statistics (too extreme at the lower side or upper side). The two observed test statistics are different show that the new added 7 points in subset 2 "pulled back" a little the mean for the sepal width of the two species we compared with, meaning new data are more "alike" in terms of sepal width. 
```

Calculate 2-sided **p-value** for the 2 tests:
```{r}
p_value_left_subset1 <- p_value_mc_left(ptest_stats_subset1, observed_value_subset1)
p_value_right_subset1 <- p_value_mc_right(ptest_stats_subset1, observed_value_subset1)
cat(p_value_left_subset1, p_value_right_subset1, sep = " ", fill = TRUE)

p_value_left_subset2 <- p_value_mc_left(ptest_stats_subset2, observed_value_subset2)
p_value_right_subset2 <- p_value_mc_right(ptest_stats_subset2, observed_value_subset2)
cat(p_value_left_subset2, p_value_right_subset2, sep = " ", fill = TRUE)
```

**Comments**:
```
- Left-sided test: the probability of permuted value is smaller than observed value
- Right-sided test: the probability of permuted value is larger than observed value
- The results of both 2 tests show that left sided p-value is much smaller that right-sided p-value (0.904 > 0.140, 0.876 > 0.290), which indicates that compared to observed values (-0.35, -0.2), the permuted values are expected to be found at the righter side; 
- the right-sided p-value of subset 1 is bigger than that of subset 2 (0.904 > 0.876), meaning the observed value of subset 1 is less likely to be found in the permutation test (only < 10% chance that it occurs at the observed position). 
```

## Exercise 2
```{r}
#install.packages("devtools")
devtools::install_github("ewan/stats_course", subdir="data/stress_shift")
```

### Task A
```{r}
df_unamb <- stressshift::stress_shift_unamb
stress_shift_3dict <- dplyr::filter(df_unamb, Dict %in% c("W1802", "J1917", "C1687"))
print(nrow(stress_shift_3dict))
```

### Task B
```{r}
stress_shift_3dict_using_pipe <- df_unamb %>% dplyr::filter(Dict %in% c("W1802", "J1917", "C1687"))
identical(stress_shift_3dict, stress_shift_3dict_using_pipe)
```

### Task C
```{r}
stress_shift_3dict_nouns <- dplyr::filter(stress_shift_3dict, Category=="Noun")
stress_shift_3dict_verbs <- dplyr::filter(stress_shift_3dict, Category=="Verb")

stress_shift_3dict_using_bind <- dplyr::bind_rows(stress_shift_3dict_nouns, stress_shift_3dict_verbs)
stress_shift_3dict_using_bind_reversed <- dplyr::bind_rows(stress_shift_3dict_verbs, stress_shift_3dict_nouns)

#check which of the two binded tables is identical with stress_shift_3dict
identical(stress_shift_3dict_using_bind, stress_shift_3dict) 
identical(stress_shift_3dict_using_bind_reversed, stress_shift_3dict)
```

The first binded table `stress_shift_3dict_using_bind` is identical with the `stress_shift_3dict` and the reversed one is not:

- When create the table `stress_shift_3dict`, the original dataframe sorted the category albaphetcally, which means nouns appear in front of the verbs. 
- When bind the separated dataframs `stress_shift_3dict_nouns` and `stress_shift_3dict_verbs` together, fonction `bind_rows` takes the first argument infront of the second one to create a new dataframe. 
- fonction `identical()` checks the exactly equality between two arguemnts. When comparing `stress_shift_3dict_using_bind` and `stress_shift_3dict`, they have the same ordering, so identical; while `stress_shift_3dict_using_bind_reversed` is not because the odering of Category is not the same.
- It wouldn't matter which one I'm working with since the content of the two tables is the same, I could use fonction `arrange(Category)`


### Task D
```{r}
stress_shift_nouns_renamed <- df_unamb %>% 
  dplyr::filter(Category=="Noun") %>%
  dplyr::select(Word, Dict, Syllable) %>%
  dplyr::rename(Syllable_Noun=Syllable)
  
stress_shift_verbs_renamed <- df_unamb %>% 
  dplyr::filter(Category=="Verb") %>%
  dplyr::select(Word, Dict, Syllable) %>%
  dplyr::rename(Syllable_Verb=Syllable)

stress_shift_wide <- dplyr::inner_join(stress_shift_nouns_renamed, stress_shift_verbs_renamed)

# check the rows of stress_shift_wide and the 2 renamed tables
n_v_rows <- nrow(stress_shift_nouns_renamed) + nrow(stress_shift_verbs_renamed)
wide_rows <- nrow(stress_shift_wide)
cat(nrow(stress_shift_nouns_renamed),nrow(stress_shift_verbs_renamed), n_v_rows, wide_rows)
#head(stress_shift_wide)
```

By definition, `stress_shift_wide(x, y)` is a condensed table that takes all the rows in table x where there are matching values in y and all colomns in x and y. In this case, the two renamed tables each contains 3 colomns: Word, Dict, Syllable_Category with the first 2 colomns the same name, the only difference is the third colomn. When doing an inner_join, the result is `joined by c("Word", "Dict")` which means it takes the **rows that share the same value of "Word" and "Dict"** in both of the two tables and make it only one row, that's why it has fewer rows than the two original tables.


### Task E
```{r}
# create a summarised table which sums up the counts of category and syllable combinasion
df_unamb_summarised <- df_unamb %>% group_by(Category, Syllable) %>% summarise(Value=n())
#print(df_unamb_summarised)

ggplot2::ggplot(df_unamb_summarised, ggplot2::aes_string(fill="Syllable", x="Category", y="Value")) +
  geom_bar(position="dodge", stat="identity") + ggplot2::ggtitle("Double bar plot for stress_shift_unamb")

# do the same plot for stress_shift_permit
df_permit <- stressshift::stress_shift_permit
df_permit_summarised <- df_permit %>% group_by(Category, Syllable) %>% summarise(Value=n())
ggplot2::ggplot(df_permit_summarised, ggplot2::aes_string(fill="Syllable", x="Category", y="Value")) +
  geom_bar(position="dodge", stat="identity") + ggplot2::ggtitle("Double bar plot for stress_shift_permit")

```











